<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Dramas - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .drama-list-item {
            cursor: pointer;
            transition: background 0.2s;
        }

        .drama-list-item:hover {
            background-color: #e9ecef;
        }

        .drama-list-item.active {
            background-color: #0d6efd;
            color: white;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="row vh-100">
            <!-- Sidebar: List -->
            <div class="col-md-4 col-lg-3 bg-white border-end p-0 d-flex flex-column">
                <div class="p-3 border-bottom">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0">Dramas</h5>
                        <a href="index.html" class="btn btn-sm btn-outline-secondary"><i class="bi bi-arrow-left"></i>
                            Voltar</a>
                    </div>
                    <div class="input-group">
                        <input type="text" class="form-control" id="searchInput" placeholder="Buscar...">
                        <button class="btn btn-outline-secondary" type="button" onclick="loadDramas()">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                    <button class="btn btn-primary w-100 mt-2" onclick="showAddForm()">
                        <i class="bi bi-plus-lg"></i> Novo Drama
                    </button>
                </div>
                <div class="flex-grow-1 overflow-auto" id="dramaList">
                    <!-- List items injected here -->
                    <div class="text-center p-3 text-muted">Carregando...</div>
                </div>
            </div>

            <!-- Main Area: Form -->
            <div class="col-md-8 col-lg-9 p-4 overflow-auto">
                <div id="welcomeMessage" class="text-center mt-5 text-muted">
                    <i class="bi bi-pencil-square display-1"></i>
                    <h3 class="mt-3">Selecione um drama para editar ou crie um novo.</h3>
                </div>

                <div id="dramaFormContainer" class="d-none">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2 id="formTitle">Novo Drama</h2>
                        <button class="btn btn-outline-danger" id="btnDelete" onclick="deleteDrama()"
                            style="display: none;">
                            <i class="bi bi-trash"></i> Excluir
                        </button>
                    </div>

                    <form id="dramaForm">
                        <input type="hidden" id="dramaId">

                        <div class="row g-3">
                            <div class="col-md-8">
                                <label class="form-label">Título</label>
                                <input type="text" class="form-control" id="title" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Ano</label>
                                <input type="number" class="form-control" id="ano">
                            </div>

                            <div class="col-md-12">
                                <label class="form-label">URL da Imagem (Poster)</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="image" onchange="previewImage()">
                                    <button class="btn btn-outline-secondary" type="button"
                                        onclick="previewImage()">Ver</button>
                                </div>
                                <div class="mt-2" id="imgPreview"></div>
                            </div>

                            <div class="col-md-6">
                                <label class="form-label">Gêneros (separados por vírgula)</label>
                                <input type="text" class="form-control" id="genres" placeholder="Romance, Comédia...">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Episódios</label>
                                <input type="number" class="form-control" id="episodios">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="status">
                                    <option value="">Selecione...</option>
                                    <option value="Assistidos">Assistidos</option>
                                    <option value="Assistindo">Assistindo</option>
                                    <option value="Assistir em breve">Assistir em breve</option>
                                    <option value="Terminar de assistir">Terminar de assistir</option>
                                </select>
                            </div>

                            <div class="col-12">
                                <label class="form-label">Sinopse</label>
                                <textarea class="form-control" id="sinopse" rows="4"></textarea>
                            </div>

                            <div class="col-12">
                                <label class="form-label">Elenco (separados por vírgula)</label>
                                <input type="text" class="form-control" id="elenco" placeholder="Ator 1, Atriz 2...">
                                <div class="form-text">Para melhor compatibilidade, use os nomes exatos.</div>
                            </div>
                        </div>

                        <hr class="my-4">

                        <div class="d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-secondary" onclick="resetForm()">Cancelar</button>
                            <button type="submit" class="btn btn-success px-4" id="btnSave">Salvar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../assets/js/config.js"></script>
    <script src="../assets/js/supa-client.js"></script>
    <script src="auth.js"></script>
    <script>
        let allDramas = [];

        document.addEventListener('DOMContentLoaded', () => {
            loadDramas();
        });

        // Autenticação delegada ao auth.js (carregado acima).
        // A função checkAdmin() abaixo é apenas um fallback local redundante.
        function checkAdmin() {
            // auth.js já realizou a verificação completa de sessão e email.
            // Nenhuma ação adicional necessária aqui.
        }

        async function loadDramas() {
            const listEl = document.getElementById('dramaList');
            const searchVal = document.getElementById('searchInput').value.toLowerCase();
            listEl.innerHTML = '<div class="text-center p-3 text-muted">Carregando...</div>';

            const { data, error } = await window.supabaseClient
                .from('dramas')
                .select('id, title')
                .order('title', { ascending: true });

            if (error) {
                listEl.innerHTML = `<div class="text-danger p-3">Erro: ${error.message}</div>`;
                return;
            }

            allDramas = data;
            renderList(searchVal);
        }

        function renderList(filter = '') {
            const listEl = document.getElementById('dramaList');
            listEl.innerHTML = '';

            const filtered = allDramas.filter(d => d.title.toLowerCase().includes(filter));

            if (filtered.length === 0) {
                listEl.innerHTML = '<div class="text-center p-3 text-muted">Nenhum drama encontrado.</div>';
                return;
            }

            filtered.forEach(d => {
                const item = document.createElement('div');
                item.className = 'p-3 border-bottom drama-list-item';
                item.textContent = d.title;
                item.onclick = () => loadDramaDetails(d.id);
                listEl.appendChild(item);
            });
        }

        document.getElementById('searchInput').addEventListener('input', (e) => {
            renderList(e.target.value.toLowerCase());
        });

        async function loadDramaDetails(id) {
            // Highlight list item (optional implementation)

            const { data, error } = await window.supabaseClient
                .from('dramas')
                .select('*')
                .eq('id', id)
                .single();

            if (error) {
                alert('Erro ao carregar detalhes');
                return;
            }

            showForm(data);
        }

        function showAddForm() {
            showForm(null);
        }

        function showForm(drama) {
            document.getElementById('welcomeMessage').classList.add('d-none');
            document.getElementById('dramaFormContainer').classList.remove('d-none');

            document.getElementById('dramaId').value = drama ? drama.id : '';
            document.getElementById('formTitle').textContent = drama ? 'Editar Drama' : 'Novo Drama';
            document.getElementById('btnDelete').style.display = drama ? 'inline-block' : 'none';

            // Fields
            document.getElementById('title').value = drama ? drama.title : '';
            document.getElementById('ano').value = drama ? drama.ano : '';
            document.getElementById('image').value = drama ? drama.image : '';
            document.getElementById('genres').value = drama && drama.genres ? drama.genres.join(', ') : '';
            document.getElementById('episodios').value = drama ? drama.episodios : '';
            document.getElementById('status').value = drama ? drama.status : '';
            document.getElementById('sinopse').value = drama ? drama.sinopse : '';
            document.getElementById('elenco').value = drama && drama.elenco ? drama.elenco.join(', ') : '';

            previewImage();
        }

        function previewImage() {
            let val = document.getElementById('image').value.trim();
            const container = document.getElementById('imgPreview');

            if (!val) {
                container.innerHTML = '';
                return;
            }

            // Heuristic to determine if it's a full URL or a filename
            // If it starts with http, use as is.
            // If it starts with assets/, prepend ../ (since we are in admin/)
            // allow user implementation of ./assets/img/
            // If it has no slashes, assume it's just the name (e.g. "18-Again") -> ../assets/img/NAME.webp

            let src = val;
            if (!val.startsWith('http') && !val.startsWith('data:')) {
                if (val.startsWith('assets/')) {
                    src = '../' + val;
                } else if (!val.includes('/') && !val.includes('.')) {
                    // Assume it's a drama name without extension -> add default path and .webp
                    src = `../assets/img/${val}.webp`;
                } else if (!val.includes('/')) {
                    // Has extension but no path -> add path
                    src = `../assets/img/${val}`;
                }
            }

            container.innerHTML = `<img src="${src}" alt="Preview: ${val}" 
                style="height: 150px; width: auto; object-fit: cover; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);" 
                onerror="this.onerror=null; this.src='../assets/img/placeholder.jpg'; this.title='Imagem não encontrada';">`;
        }

        function resetForm() {
            document.getElementById('dramaFormContainer').classList.add('d-none');
            document.getElementById('welcomeMessage').classList.remove('d-none');
        }

        // SAVE
        document.getElementById('dramaForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSave');
            btn.disabled = true;
            btn.textContent = 'Salvando...';

            const id = document.getElementById('dramaId').value;
            const payload = {
                title: document.getElementById('title').value.trim(),
                ano: parseInt(document.getElementById('ano').value) || null,
                image: document.getElementById('image').value.trim(),
                genres: document.getElementById('genres').value.split(',').map(s => s.trim()).filter(Boolean),
                episodios: parseInt(document.getElementById('episodios').value) || null,
                status: document.getElementById('status').value || null,
                sinopse: document.getElementById('sinopse').value.trim(),
                elenco: document.getElementById('elenco').value.split(',').map(s => s.trim()).filter(Boolean)
            };

            let error;
            if (id) {
                // Update
                const res = await window.supabaseClient.from('dramas').update(payload).eq('id', id);
                error = res.error;
            } else {
                // Insert
                const res = await window.supabaseClient.from('dramas').insert([payload]);
                error = res.error;
            }

            btn.disabled = false;
            btn.textContent = 'Salvar';

            if (error) {
                alert('Erro ao salvar: ' + error.message);
            } else {
                alert('Salvo com sucesso!');
                resetForm();
                loadDramas(); // Reload list
            }
        });

        // DELETE
        async function deleteDrama() {
            const id = document.getElementById('dramaId').value;
            if (!id) return;

            if (!confirm('Tem certeza que wdeseja EXCLUIR este drama? Essa ação não pode ser desfeita.')) return;

            const { error } = await window.supabaseClient.from('dramas').delete().eq('id', id);

            if (error) {
                alert('Erro ao excluir: ' + error.message);
            } else {
                alert('Drama excluído.');
                resetForm();
                loadDramas();
            }
        }
    </script>
</body>

</html>