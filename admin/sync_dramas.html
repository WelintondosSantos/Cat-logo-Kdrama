<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Sincronizar Dramas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-dark text-white container py-5">
    <div class="card bg-secondary text-white">
        <div class="card-header">
            <h1>Sincronizar Dramas (JSON -> Supabase)</h1>
        </div>
        <div class="card-body">
            <p class="card-text">
                Este utilit√°rio l√™ o arquivo local <code>dramas.json</code> e atualiza o banco de dados Supabase.<br>
                Novos dramas ser√£o adicionados. Dramas existentes ser√£o atualizados (baseado no T√≠tulo).
            </p>

            <div class="mb-3">
                <label class="form-label">Supabase URL & Key (Do supa-client.js)</label>
                <div class="input-group">
                    <span class="input-group-text">Status</span>
                    <input type="text" class="form-control" id="status" value="Aguardando..." readonly>
                </div>
            </div>

            <button id="syncBtn" class="btn btn-primary w-100">Iniciar Sincroniza√ß√£o</button>
        </div>
    </div>

    <div class="mt-4">
        <h5>Log de Opera√ß√µes:</h5>
        <div id="output" class="p-3 bg-black rounded font-monospace"
            style="height: 400px; overflow-y: scroll; white-space: pre-wrap; color: #0f0;"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../assets/js/supa-client.js"></script>
    <script>
        const output = document.getElementById('output');
        const statusDetails = document.getElementById('status');

        const log = (msg) => {
            const time = new Date().toLocaleTimeString();
            output.innerHTML += `[${time}] ${msg}\n`;
            output.scrollTop = output.scrollHeight;
        };

        const updateStatus = (msg) => {
            statusDetails.value = msg;
        };

        document.getElementById('syncBtn').addEventListener('click', async () => {
            log('üöÄ Iniciando processo de sincroniza√ß√£o...');
            updateStatus('Lendo dramas.json...');

            try {
                // 1. Ler arquivo JSON local
                const response = await fetch('../data/dramas.json');
                if (!response.ok) throw new Error('N√£o foi poss√≠vel encontrar ou ler dramas.json');
                const dramas = await response.json();

                log(`üìÇ Arquivo JSON carregado com sucesso. Total de itens: ${dramas.length}`);

                if (dramas.length === 0) {
                    log('‚ö†Ô∏è O arquivo JSON est√° vazio. Nada a fazer.');
                    return;
                }

                updateStatus('Conectando ao Supabase...');
                const client = window.supabaseClient;
                if (!client) throw new Error('Cliente Supabase n√£o inicializado (verifique supa-client.js)');

                // 2. Pr√©-carregar dados do Supabase para evitar duplicatas e N+1 queries
                updateStatus('Baixando lista atual do Supabase...');
                const { data: existingDramasRaw, error: fetchError } = await client
                    .from('dramas')
                    .select('id, title');

                if (fetchError) throw new Error('Erro ao buscar dramas existentes: ' + fetchError.message);

                // Mapa: Chave Normalizada -> ID
                const existingMap = new Map();
                existingDramasRaw.forEach(d => {
                    const key = d.title.toLowerCase().replace(/[^a-z0-9]/g, '');
                    existingMap.set(key, d.id);
                });

                log(`üìã Base atual: ${existingDramasRaw.length} dramas no banco.`);

                // 3. Processar
                let added = 0;
                let updated = 0;
                let errors = 0;

                updateStatus(`Processando ${dramas.length} dramas...`);

                for (let i = 0; i < dramas.length; i++) {
                    const drama = dramas[i];
                    const percent = Math.round(((i + 1) / dramas.length) * 100);

                    // Normalizar t√≠tulo do JSON para busca
                    const searchKey = drama.title.toLowerCase().replace(/[^a-z0-9]/g, '');

                    // Payload
                    const dramaPayload = {
                        title: drama.title,
                        image: drama.image,
                        genres: drama.genres,
                        status: drama.status || null,
                        ano: drama.ano || null,
                        sinopse: drama.sinopse || null,
                        elenco: drama.elenco || [],
                        episodios: drama.episodios || null
                    };

                    const existingId = existingMap.get(searchKey);

                    if (existingId) {
                        // UPDATE
                        const { error: updateError } = await client
                            .from('dramas')
                            .update(dramaPayload)
                            .eq('id', existingId);

                        if (updateError) {
                            log(`‚ùå Falha ao atualizar "${drama.title}": ${updateError.message}`);
                            errors++;
                        } else {
                            updated++;
                        }
                    } else {
                        // INSERT
                        log(`‚ú® Novo: "${drama.title}"`);
                        const { data: newDrama, error: insertError } = await client
                            .from('dramas')
                            .insert([dramaPayload])
                            .select('id')
                            .single();

                        if (insertError) {
                            log(`‚ùå Falha ao inserir "${drama.title}": ${insertError.message}`);
                            errors++;
                        } else {
                            added++;
                            // Atualizar mapa para evitar duplicatas no mesmo lote
                            if (newDrama) existingMap.set(searchKey, newDrama.id);
                        }
                    }

                    // Atualizar UI a cada 10 items
                    if (i % 10 === 0) updateStatus(`Processando... ${percent}%`);
                }

                updateStatus('Conclu√≠do!');
                log('-----------------------------------');
                log('üéâ Sincroniza√ß√£o Finalizada!');
                log(`‚ûï Adicionados: ${added}`);
                log(`üîÑ Atualizados: ${updated}`);
                log(`‚ùå Erros: ${errors}`);
                log('-----------------------------------');
                log('üí° DICA: Atualize a p√°gina principal para ver as altera√ß√µes.');

            } catch (err) {
                log(`‚õî ERRO FATAL: ${err.message}`);
                console.error(err);
                updateStatus('Erro Fatal');
            }
        });
    </script>
</body>

</html>