<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Gerenciar Imagens</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        .img-card {
            transition: transform 0.2s;
        }

        .img-card:hover {
            transform: scale(1.05);
        }

        .img-thumb {
            height: 200px;
            object-fit: cover;
        }

        .unused {
            border: 2px solid #ffc107;
        }

        .used {
            border: 2px solid #198754;
        }
    </style>
</head>

<body class="bg-dark text-white">
    <div class="container py-4">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>üñºÔ∏è Gerenciar Imagens</h1>
            <div>
                <a href="../index.html" class="btn btn-outline-light">Voltar ao Site</a>
                <a href="edit_drama.html" class="btn btn-outline-info">Editar Dramas</a>
            </div>
        </div>

        <!-- Toolbar -->
        <div class="card bg-secondary text-white mb-4">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div class="d-flex gap-3 align-items-center">
                    <input type="file" id="uploadInput" class="form-control" accept="image/*">
                    <button id="uploadBtn" class="btn btn-primary">
                        <i class="bi bi-cloud-upload"></i> Upload
                    </button>
                    <span id="uploadStatus"></span>
                </div>
                <div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="filterUnused">
                        <label class="form-check-label" for="filterUnused">Mostrar apenas n√£o usadas</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats -->
        <div class="row mb-3 text-center">
            <div class="col-md-4">
                <h3><span id="totalCount" class="badge bg-primary">0</span></h3>
                <p>Total de Imagens</p>
            </div>
            <div class="col-md-4">
                <h3><span id="unusedCount" class="badge bg-warning text-dark">0</span></h3>
                <p>N√£o Usadas (Sugerido Excluir)</p>
            </div>
            <div class="col-md-4">
                <h3><span id="jsonCount" class="badge bg-info text-dark">0</span></h3>
                <p>Dramas no JSON</p>
            </div>
        </div>

        <!-- Gallery -->
        <div id="gallery" class="row row-cols-1 row-cols-md-4 g-4">
            <!-- Images go here -->
            <div class="col text-center w-100 mt-5">
                <div class="spinner-border" role="status"></div>
                <p class="mt-2">Carregando imagens do servidor local...</p>
                <small class="text-danger d-block">Certifique-se de que "node admin/server.js" est√° rodando!</small>
            </div>
        </div>
    </div>

    <script>
        const SERVER_URL = 'http://localhost:3000';
        const gallery = document.getElementById('gallery');
        const uploadInput = document.getElementById('uploadInput');
        const uploadBtn = document.getElementById('uploadBtn');
        const uploadStatus = document.getElementById('uploadStatus');
        const filterUnused = document.getElementById('filterUnused');

        let allImages = [];
        let usedImages = new Set();

        async function init() {
            try {
                // 1. Fetch JSON to know what is used
                const jsonResp = await fetch('../data/dramas.json');
                const dramas = await jsonResp.json();
                document.getElementById('jsonCount').textContent = dramas.length;

                usedImages = new Set();
                dramas.forEach(d => {
                    if (d.image) usedImages.add(d.image.toLowerCase());
                });

                // 2. Fetch Images from Local Server
                await loadImages();

            } catch (err) {
                console.error(err);
                gallery.innerHTML = `
                    <div class="alert alert-danger w-100 text-center">
                        <h4>Erro ao conectar com o Servidor Local</h4>
                        <p>Verifique se voc√™ rodou o comando: <code>node admin/server.js</code></p>
                        <hr>
                        <small>${err.message}</small>
                    </div>
                `;
            }
        }

        async function loadImages() {
            const resp = await fetch(`${SERVER_URL}/api/images`);
            if (!resp.ok) throw new Error('Falha ao listar imagens');

            allImages = await resp.json();
            renderGallery();
        }

        function renderGallery() {
            const showUnusedOnly = filterUnused.checked;
            gallery.innerHTML = '';

            let total = 0;
            let unused = 0;

            allImages.forEach(filename => {
                // Remove extension to check usage
                const nameWithoutExt = filename.replace(/\.[^/.]+$/, "").toLowerCase();
                const isUsed = usedImages.has(nameWithoutExt);

                if (!isUsed) unused++;
                total++;

                if (showUnusedOnly && isUsed) return;

                const col = document.createElement('div');
                col.className = 'col';
                col.innerHTML = `
                    <div class="card h-100 bg-secondary img-card ${isUsed ? 'used' : 'unused'}">
                        <img src="../assets/img/${filename}" class="card-img-top img-thumb" alt="${filename}">
                        <div class="card-body">
                            <h5 class="card-title text-truncate" title="${filename}">${filename}</h5>
                            <p class="card-text">
                                <span class="badge ${isUsed ? 'bg-success' : 'bg-warning text-dark'}">
                                    ${isUsed ? 'Em Uso' : 'N√£o Usado'}
                                </span>
                            </p>
                            <button class="btn btn-danger btn-sm w-100" onclick="deleteImage('${filename}')">
                                <i class="bi bi-trash"></i> Excluir
                            </button>
                        </div>
                    </div>
                `;
                gallery.appendChild(col);
            });

            document.getElementById('totalCount').textContent = total;
            document.getElementById('unusedCount').textContent = unused;
        }

        async function deleteImage(filename) {
            if (!confirm(`Tem certeza que deseja excluir "${filename}"?`)) return;

            try {
                const resp = await fetch(`${SERVER_URL}/api/images/${filename}`, {
                    method: 'DELETE'
                });

                if (!resp.ok) throw new Error('Erro ao deletar');

                // Refresh
                await loadImages();

            } catch (err) {
                alert('Erro: ' + err.message);
            }
        }

        uploadBtn.addEventListener('click', async () => {
            const file = uploadInput.files[0];
            if (!file) {
                alert('Selecione um arquivo!');
                return;
            }

            const formData = new FormData();
            formData.append('image', file);

            uploadBtn.disabled = true;
            uploadStatus.textContent = 'Enviando...';

            try {
                const resp = await fetch(`${SERVER_URL}/api/upload`, {
                    method: 'POST',
                    body: formData
                });

                if (!resp.ok) throw new Error('Erro no upload');

                const data = await resp.json();
                uploadStatus.textContent = '‚úÖ Sucesso!';
                uploadInput.value = ''; // clear

                // Refresh gallery
                await loadImages();

            } catch (err) {
                console.error(err);
                alert('Erro no upload: ' + err.message);
                uploadStatus.textContent = '‚ùå Erro';
            } finally {
                uploadBtn.disabled = false;
                setTimeout(() => uploadStatus.textContent = '', 3000);
            }
        });

        filterUnused.addEventListener('change', renderGallery);

        init();
    </script>
</body>

</html>