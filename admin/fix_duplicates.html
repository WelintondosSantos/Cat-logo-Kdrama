<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Duplicates Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light p-5">
    <div class="container bg-white p-5 rounded shadow">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Admin: Fix Duplicates</h1>
            <a href="index.html" class="btn btn-outline-secondary">Voltar ao Dashboard</a>
        </div>
        <p class="lead">This tool will scan your <code>dramas</code> table and remove duplicate entries based on the
            <strong>Title</strong>. It keeps the entry with the lowest ID (oldest).
        </p>

        <div class="mb-3">
            <label class="form-label">Supabase Connection</label>
            <div class="input-group">
                <span class="input-group-text">Status</span>
                <input type="text" class="form-control" id="status" value="Aguardando..." readonly>
            </div>
            <small class="text-muted">Uses credentials from <code>assets/js/supa-client.js</code></small>
        </div>

        <button id="startBtn" class="btn btn-danger" onclick="startCleanup()">Find & Fix Duplicates</button>

        <div class="mt-4">
            <h5>Log:</h5>
            <pre id="log" class="bg-dark text-light p-3 rounded" style="height: 400px; overflow-y: scroll;"></pre>
        </div>
    </div>

    <!-- Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../assets/js/supa-client.js"></script>

    <script>
        const logEl = document.getElementById('log');
        const statusEl = document.getElementById('status');
        const startBtn = document.getElementById('startBtn');

        function log(msg) {
            logEl.innerHTML += `<div>${new Date().toLocaleTimeString()} - ${msg}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        async function startCleanup() {
            startBtn.disabled = true;
            statusEl.value = "Conectando...";

            const supabase = window.supabaseClient;

            if (!supabase) {
                alert('Supabase client not initialized. Check supa-client.js');
                log('‚ùå Error: Supabase client not found.');
                return;
            }

            log('üöÄ Starting cleanup...');

            try {
                // 1. Fetch all dramas (just id and title to save bandwidth)
                log('Fetching all dramas...');
                const { data: dramas, error } = await supabase
                    .from('dramas')
                    .select('id, title')
                    .order('id', { ascending: true });

                if (error) {
                    log('‚ùå Error fetching dramas: ' + error.message);
                    statusEl.value = "Erro";
                    startBtn.disabled = false;
                    return;
                }

                log(`Fetched ${dramas.length} rows.`);

                // 2. Identify Duplicates
                const uniqueTitles = new Set();
                const duplicatesToDelete = [];

                // Since we ordered by ID ascending, the first time we see a title, it's the oldest (keep it).
                // Any subsequent encounter of the same title is a duplicate (delete it).
                dramas.forEach(drama => {
                    if (!drama.title) return; // Skip empty titles

                    const normalizedTitle = drama.title.trim().toLowerCase();

                    if (uniqueTitles.has(normalizedTitle)) {
                        duplicatesToDelete.push(drama);
                    } else {
                        uniqueTitles.add(normalizedTitle);
                    }
                });

                if (duplicatesToDelete.length === 0) {
                    log('‚úÖ No duplicates found! Your database is clean.');
                    statusEl.value = "Limpo";
                    startBtn.disabled = false;
                    return;
                }

                log(`‚ö†Ô∏è Found ${duplicatesToDelete.length} duplicate entries.`);
                log('Deleting duplicates...');
                statusEl.value = `Deletando ${duplicatesToDelete.length} itens...`;

                // 3. Delete Duplicates
                const idsToDelete = duplicatesToDelete.map(d => d.id);

                const { error: deleteError } = await supabase
                    .from('dramas')
                    .delete()
                    .in('id', idsToDelete);

                if (deleteError) {
                    log('‚ùå Error deleting duplicates: ' + deleteError.message);
                    statusEl.value = "Erro na dele√ß√£o";
                } else {
                    log(`‚úÖ Successfully deleted ${idsToDelete.length} duplicates.`);
                    log('List of deleted IDs: ' + idsToDelete.join(', '));
                    statusEl.value = "Conclu√≠do com Sucesso";
                }

            } catch (e) {
                log('‚ùå Unexpected error: ' + e.message);
                console.error(e);
                statusEl.value = "Erro Inesperado";
            } finally {
                startBtn.disabled = false;
            }
        }
    </script>
</body>

</html>