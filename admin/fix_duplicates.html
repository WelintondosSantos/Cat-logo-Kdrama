<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Duplicates Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-light p-5">
    <div class="container bg-white p-5 rounded shadow">
        <h1>Admin: Fix Duplicates</h1>
        <p class="lead">This tool will scan your <code>dramas</code> table and remove duplicate entries based on the
            <strong>Title</strong>. It keeps the entry with the lowest ID (oldest).</p>

        <div class="mb-3">
            <label class="form-label">Supabase Project URL</label>
            <input type="text" id="supaUrl" class="form-control" value="https://qgvqhzptkgtbuxcxiiph.supabase.co">
        </div>
        <div class="mb-3">
            <label class="form-label">Supabase Anon Key</label>
            <input type="text" id="supaKey" class="form-control" value="sb_publishable_vmeXKKSRI1cERYF47eiKAg_wp_NeEXa">
        </div>

        <button class="btn btn-danger" onclick="startCleanup()">Find & Fix Duplicates</button>

        <div class="mt-4">
            <h5>Log:</h5>
            <pre id="log" class="bg-dark text-light p-3 rounded" style="height: 400px; overflow-y: scroll;"></pre>
        </div>
    </div>

    <script>
        function log(msg) {
            const logEl = document.getElementById('log');
            logEl.innerHTML += `<div>${new Date().toLocaleTimeString()} - ${msg}</div>`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        async function startCleanup() {
            const url = document.getElementById('supaUrl').value.trim();
            const key = document.getElementById('supaKey').value.trim();

            if (!url || !key) {
                alert('Please enter URL and Key');
                return;
            }

            const supabase = window.supabase.createClient(url, key);
            log('Starting cleanup...');

            try {
                // 1. Fetch all dramas (just id and title to save bandwidth)
                log('Fetching all dramas...');
                const { data: dramas, error } = await supabase
                    .from('dramas')
                    .select('id, title')
                    .order('id', { ascending: true });

                if (error) {
                    log('Error fetching dramas: ' + error.message);
                    return;
                }

                log(`Fetched ${dramas.length} rows.`);

                // 2. Identify Duplicates
                const uniqueTitles = new Set();
                const duplicatesToDelete = [];

                // Since we ordered by ID ascending, the first time we see a title, it's the oldest (keep it).
                // Any subsequent encounter of the same title is a duplicate (delete it).
                dramas.forEach(drama => {
                    const normalizedTitle = drama.title.trim().toLowerCase(); // Normalize to catch case-sensitive dupes if needed

                    if (uniqueTitles.has(normalizedTitle)) {
                        duplicatesToDelete.push(drama);
                    } else {
                        uniqueTitles.add(normalizedTitle);
                    }
                });

                if (duplicatesToDelete.length === 0) {
                    log('✅ No duplicates found! Your database is clean.');
                    return;
                }

                log(`⚠️ Found ${duplicatesToDelete.length} duplicate entries.`);
                log('Deleting duplicates...');

                // 3. Delete Duplicates
                // Delete in batches to be safe
                const idsToDelete = duplicatesToDelete.map(d => d.id);

                const { error: deleteError } = await supabase
                    .from('dramas')
                    .delete()
                    .in('id', idsToDelete);

                if (deleteError) {
                    log('Error deleting duplicates: ' + deleteError.message);
                } else {
                    log(`✅ Successfully deleted ${idsToDelete.length} duplicates.`);
                    log('List of deleted IDs: ' + idsToDelete.join(', '));
                }

            } catch (e) {
                log('Unexpected error: ' + e.message);
                console.error(e);
            }
        }
    </script>
</body>

</html>