<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Duplicates Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body class="bg-dark text-white container py-5">
    <div class="card bg-secondary text-white">
        <div class="card-header">
            <h1>üõ†Ô∏è Corrigir Duplicatas</h1>
        </div>
        <div class="card-body">
            <p class="card-text">
                Esta ferramenta busca por t√≠tulos similares (ignorando espa√ßos, mai√∫sculas e s√≠mbolos) e permite remover
                as duplicatas.
            </p>

            <button id="scanBtn" class="btn btn-primary w-100 mb-3">üîç Escanear Banco de Dados</button>

            <div id="resultsArea" style="display: none;">
                <div class="alert alert-info" id="statusMsg"></div>
                <button id="fixAllBtn" class="btn btn-danger w-100 mb-3" style="display: none;">
                    üöÄ Corrigir Todas (Manter a mais antiga)
                </button>
                <div id="duplicateList" class="list-group text-dark"></div>
            </div>

            <div class="mt-3">
                <h5>Log:</h5>
                <pre id="log" class="bg-black text-success p-3 rounded"
                    style="height: 200px; overflow-y: scroll;"></pre>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../assets/js/supa-client.js"></script>
    <script>
        const logEl = document.getElementById('log');
        const resultsArea = document.getElementById('resultsArea');
        const statusMsg = document.getElementById('statusMsg');
        const duplicateList = document.getElementById('duplicateList');
        const fixAllBtn = document.getElementById('fixAllBtn');

        let duplicateGroups = [];

        function log(msg) {
            const time = new Date().toLocaleTimeString();
            logEl.innerHTML += `[${time}] ${msg}\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        // Helper to remove special chars for comparison
        function normalizeTitle(title) {
            return title.toLowerCase().replace(/[^a-z0-9]/g, '');
        }

        document.getElementById('scanBtn').addEventListener('click', async () => {
            log('Iniciando escaneamento...');
            resultsArea.style.display = 'block';
            statusMsg.textContent = 'Buscando dramas...';
            statusMsg.className = 'alert alert-info';
            duplicateList.innerHTML = '';
            fixAllBtn.style.display = 'none';
            duplicateGroups = [];

            try {
                const client = window.supabaseClient;
                if (!client) throw new Error('Supabase client not initialized');

                const { data: dramas, error } = await client
                    .from('dramas')
                    .select('id, title') // Fetch id to decide which to keep
                    .order('id', { ascending: true }); // Oldest first

                if (error) throw error;

                log(`Total de dramas encontrados: ${dramas.length}`);

                // Grouping Logic
                const groups = {};
                dramas.forEach(d => {
                    const key = normalizeTitle(d.title);
                    if (!groups[key]) groups[key] = [];
                    groups[key].push(d);
                });

                // Filter groups with > 1 item
                Object.keys(groups).forEach(key => {
                    if (groups[key].length > 1) {
                        duplicateGroups.push(groups[key]);
                    }
                });

                if (duplicateGroups.length === 0) {
                    statusMsg.textContent = '‚úÖ Nenhuma duplicata encontrada!';
                    statusMsg.className = 'alert alert-success';
                    log('O banco est√° limpo.');
                } else {
                    statusMsg.textContent = `‚ö†Ô∏è Encontrados ${duplicateGroups.length} grupos de duplicatas.`;
                    statusMsg.className = 'alert alert-warning';
                    renderDuplicates();
                    fixAllBtn.style.display = 'block';
                }

            } catch (err) {
                log('Erro: ' + err.message);
                console.error(err);
            }
        });

        function renderDuplicates() {
            duplicateList.innerHTML = '';
            duplicateGroups.forEach((group, index) => {
                const keep = group[0]; // First one (oldest due to sort)
                const remove = group.slice(1);

                const item = document.createElement('div');
                item.className = 'list-group-item';
                item.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <h5 class="mb-1">Grupo ${index + 1}: "${keep.title}"</h5>
                        <small>${group.length} ocorr√™ncias</small>
                    </div>
                    <p class="mb-1 text-success">Manter: ${keep.title} (ID: ${keep.id})</p>
                    ${remove.map(d => `<p class="mb-1 text-danger">Remover: ${d.title} (ID: ${d.id})</p>`).join('')}
                `;
                duplicateList.appendChild(item);
            });
        }

        fixAllBtn.addEventListener('click', async () => {
            if (!confirm('Voc√™ tem certeza? Isso apatar√° permanentemente as duplicatas listadas.')) return;

            fixAllBtn.disabled = true;
            log('Iniciando limpeza...');

            const idsToDelete = [];
            duplicateGroups.forEach(group => {
                // Keep the first one, delete the rest
                const remove = group.slice(1);
                remove.forEach(r => idsToDelete.push(r.id));
            });

            log(`Dramas para deletar: ${idsToDelete.length}`);

            try {
                const client = window.supabaseClient;

                // Delete in chunks of 20 to avoid URL limits if using REST, though Supabase client handles body well.
                const { error } = await client
                    .from('dramas')
                    .delete()
                    .in('id', idsToDelete);

                if (error) throw error;

                log('‚úÖ Limpeza conclu√≠da com sucesso!');
                alert('Limpeza conclu√≠da! Atualizando lista...');

                // Rescan
                document.getElementById('scanBtn').click();

            } catch (err) {
                log('‚ùå Erro ao deletar: ' + err.message);
                fixAllBtn.disabled = false;
            }
        });
    </script>
</body>

</html>